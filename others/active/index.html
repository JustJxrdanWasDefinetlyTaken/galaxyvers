<!--
▀█▀ 　 ░█▀▀▄ ░█▀▀▀█ 　 ░█──░█ ░█─░█ ─█▀▀█ ▀▀█▀▀ ░█▀▀▀ ░█──░█ ░█▀▀▀ ░█▀▀█ 　 ▀█▀ 　 ░█──░█ ─█▀▀█ ░█▄─░█ ▀▀█▀▀ 
░█─ 　 ░█─░█ ░█──░█ 　 ░█░█░█ ░█▀▀█ ░█▄▄█ ─░█── ░█▀▀▀ ─░█░█─ ░█▀▀▀ ░█▄▄▀ 　 ░█─ 　 ░█░█░█ ░█▄▄█ ░█░█░█ ─░█── 
▄█▄ 　 ░█▄▄▀ ░█▄▄▄█ 　 ░█▄▀▄█ ░█─░█ ░█─░█ ─░█── ░█▄▄▄ ──▀▄▀─ ░█▄▄▄ ░█─░█ 　 ▄█▄ 　 ░█▄▀▄█ ░█─░█ ░█──▀█ ─░█──--->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>JMW | Educational Tabs</title>
  <link rel="icon" href="/assets/images/jmw.png" />
  <link rel="shortcut icon" href="/assets/images/jmw.png" />

  <!-- lightweight single-show alert counter (keeps original behavior but no sensitive content) -->
  <script>
    let count = parseInt(localStorage.getItem('alertCount')) || 0;
    if (count < 1) {
      alert(
        "Reminder: this is experimental and may be buggy. If you used 'do not show again', clear site data in your browser settings for this origin."
      );
      localStorage.setItem('alertCount', count + 1);
    }
  </script>

  <!-- main module scripts -->
  <script async defer src="./js/tabs.js" type="module"></script>
  <link href="/assets/css/tabs.css" rel="stylesheet" />

  <script type="module" async defer>
    import {
      setWisp,
      setProxy,
      makeURL,
      getProxied,
      setFrames,
      addressInput,
      currentTab,
      Tab
    } from "/cat.mjs";

    // --- INIT ---
    const form = document.getElementById("form");
    let search =
      localStorage.getItem("search-engine") ||
      "https://duckduckgo.com/?q=%s";
    setProxy(localStorage.getItem("pr0xy") || "scram");

    setWisp((location.protocol === "https:" ? "wss://" : "ws://") + location.host + "/wisp/");
    async function autofill(url) {
      const urlToLoad = makeURL(url, search);
      const proxiedUrl = await getProxied(urlToLoad);
      setTimeout(() => {
        document.getElementById(`frame-${currentTab}`).src = proxiedUrl;
      }, 200);
    }

    try {
      const params = new URLSearchParams(window.location.search);
      const autofillUrl = params.get('autofill');
      if (autofillUrl) autofill(autofillUrl);
    } catch {}

    // --- EVENTS ---
    form?.addEventListener("submit", async (event) => {
      event.preventDefault();
      const urlToLoad = makeURL(addressInput.value, search);
      const proxiedUrl = await getProxied(urlToLoad);
      let currentFrame = document.getElementById(`frame-${currentTab}`);
      currentFrame.src = proxiedUrl;

      if (currentFrame === document.getElementById(`frame-${currentTab}`)) {
        addressInput.value = urlToLoad;
        if (urlToLoad == "newtab.html") addressInput.value = "jmw://newtab";
      }
    });

    setFrames(document.getElementById("frames"));
    new Tab();
  </script>

  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet" />
</head>
<body theme="classic">
  <div id="history-container" style="display:none;">
    <button id="close-history" style="float:right;margin:10px;" aria-label="Close History" title="Close History">✕</button>
    <input type="text" id="history-search" placeholder="Filter history...">
    <ul id="history-list"></ul>
    <button id="clear-history">Clear History</button>
  </div>

  <!-- custom alert modal (kept, but text sanitized) -->
  <div id="customAlert" style="display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:900px;height:300px;overflow-y:auto;background:black;color:var(--txtcolor);padding:30px;box-shadow:0 0 30px rgba(0,0,0,0.6);z-index:999999;border-radius:16px;">
    <button id="alertClose" style="position:absolute;top:15px;right:15px;background:transparent;border:none;font-size:22px;cursor:pointer;">✕</button>
    <div id="alertContent" style="overflow-y:auto;max-height:520px;background:black;color:var(--txtcolor);">
      <center>
        <br><br>
        <h1 style="font-size:16px;margin-bottom:10px;">⚠️ READ BEFORE YOU USE THIS ⚠️</h1>
        <h2 style="font-size:14px;margin-bottom:8px;">This proxy/browser UI is experimental and may behave unpredictably. If you encounter errors, try clearing site data or a hard reload.</h2>
        <h3 style="font-size:13px;margin-bottom:6px;">Common fixes</h3>
        <ul style="font-size:12px;list-style:disc;padding-left:20px;text-align:left;">
          <li>Clear cookies/site data for this origin in your browser settings and reload the page.</li>
          <li>Try a hard refresh (Ctrl+Shift+R) if content doesn't load.</li>
          <li>Use the history or open a new tab if an iframe fails to display content.</li>
        </ul>
        <h4>Join our Discord if you need help</h4>
      </center>
    </div>
    <button id="alertHide" style="display:block;margin:20px auto 0 auto;padding:10px 20px;border:none;background:#333;color:#fff;border-radius:10px;cursor:pointer;">Do not show again</button>
  </div>

  <nav>
    <div id="tabs"></div>
    <button id="new-tab-btn" aria-label="New Tab" title="New Tab"><i class='bx bx-plus'></i></button>
  </nav>

  <form id="form" align="center">
    <a href="#" id="back-btn" class="fc nav-btn" onclick="historyBack();" title="go back in iframe"><i class='bx bx-chevron-left'></i></a>
    <a href="#" id="forward-btn" class="fc nav-btn" onclick="historyForward();" title="go forward in iframe"><i class='bx bx-chevron-right'></i></a>
    <a href="#" id="reload-btn" class="fc nav-btn" onclick="reload();" title="reload iframe"><i class="bx bx-refresh"></i></a>
    <input id="address" type="text" placeholder="Search privately.." class="search" autocomplete="off" onfocus="this.select()" />
    <a href="#" id="home-icon" class="fc" onclick="window.close();" title="close the jmw tabs session"><i class="bx bx-home"></i></a>
    <a href="#" id="inspect-icon" class="fc" onclick="inspect();" title="open inspector in iframe"><i class="bx bx-code-alt"></i></a>
    <a href="#" id="fullscreen-icon" class="fc" onclick="full();" title="put iframe in fullscreen"><i class="bx bx-fullscreen"></i></a>
    <a href="#" id="more-icon" class="fc" aria-haspopup="true" aria-expanded="false" aria-controls="more-menu" role="button" title="More (dropdown)"><i class="bx bx-dots-vertical"></i></a>
  </form>

  <div id="more-menu" class="menu" role="menu">
    <a href="#" onclick="copy();" role="menuitem">Clear Session</a>
    <a href="#" onclick="registerSW();" role="menuitem">Register SW</a>
    <a href="#" role="menuitem">??? [soon!]</a>
    <div class="divider"></div>
    <a href="#" id="toggle-history" role="menuitem">History</a>
    <a href="#" role="menuitem">Bookmarks [Coming Soon]</a>
    <a href="#" onclick="disableAdverts();" role="menuitem">Disable Ads</a>
  </div>

  <section id="frames"></section>

  <!-- inject eruda into same-origin frames (keeps original function but safe-guards cross-origin) -->
  <script>
    function inspect() {
      const idFromGlobal = (typeof currentTab !== 'undefined') ?
        `frame-${currentTab}` :
        (window.currentTab ? `frame-${window.currentTab}` : null);

      let activeFrame = idFromGlobal ? document.getElementById(idFromGlobal) : null;
      if (!activeFrame) activeFrame = document.querySelector('iframe[id^="frame-"]');
      if (!activeFrame) return alert("No frame found.");

      try {
        void activeFrame.contentWindow.document;
      } catch {
        return alert("Cross-origin frame, cannot inject.");
      }

      const code = `
        (function(){
          if (window.__erudaInjected) {
            try { eruda.destroy(); } catch(e){}
            document.querySelectorAll('script[src*="eruda"]').forEach(s=>s.remove());
            window.__erudaInjected = false;
          } else {
            function load(src,next){
              var s=document.createElement('script');
              s.src=src;
              s.onload=()=>next(true);
              s.onerror=()=>next(false);
              document.body.appendChild(s);
            }
            function initAndShow() {
              eruda.init();
              eruda.show();
            }
            load('https://cdn.jsdelivr.net/npm/eruda', ok=>{
              if(!ok){
                load('https://cdn.statically.io/gh/liriliri/eruda/master/eruda.min.js', ok2=>{
                  if(!ok2){
                    load('https://rawgit.com/liriliri/eruda/master/eruda.min.js', initAndShow);
                  } else initAndShow();
                });
              } else initAndShow();
            });
            window.__erudaInjected=true;
          }
        })();
      `;
      activeFrame.contentWindow.eval(code);
    }
  </script>

  <script async defer>
    function full() {
      const activeFrame = document.querySelector('iframe[id^="frame-"]:not(.hidden)');
      if (!activeFrame) return;
      if (!document.fullscreenElement) {
        activeFrame.requestFullscreen().catch(err => {
          alert(`Error attempting to enable fullscreen mode: ${err.message} (${err.name})`);
        });
      } else {
        document.exitFullscreen();
      }
    }
  </script>

  <script src="/assets/scripts/index.js"></script>

  <script>
    function reload() {
      var iframe = document.querySelector("iframe");
      if (iframe && iframe.contentWindow) iframe.contentWindow.location.reload();
    }
    function historyBack() {
      var iframe = document.querySelector("iframe");
      if (iframe && iframe.contentWindow) iframe.contentWindow.history.back();
    }
    function historyForward() {
      var iframe = document.querySelector("iframe");
      if (iframe && iframe.contentWindow) iframe.contentWindow.history.forward();
    }
  </script>

  <script>
    (function () {
      if (localStorage.getItem("hideCustomAlert") === "true") return;
      var alertBox = document.getElementById("customAlert");
      var closeBtn = document.getElementById("alertClose");
      var hideBtn = document.getElementById("alertHide");
      alertBox.style.display = "block";
      closeBtn.addEventListener("click", function () {
        alertBox.style.display = "none";
      });
      hideBtn.addEventListener("click", function () {
        localStorage.setItem("hideCustomAlert", "true");
        alertBox.style.display = "none";
      });
    })();
  </script>

  <script>
    function copy() {
      const url = window.location.origin;
      const text = "chrome://settings/content/all?searchSubpage=" + url;
      navigator.clipboard.writeText(text).then(() => {
        alert(text + " is now in your clipboard. Please paste the URL in the search bar in a new tab.");
      });
    }
  </script>

  <script>
    const paramss = new URLSearchParams(window.location.search);
    if (paramss.has("goback")) {
      setTimeout(() => {
        window.location.replace("/");
      }, 10000);
    }
  </script>

  <!-- Safe "autofill" overlay messages (no personal/doxxing content) -->
  <script>
    if (new URLSearchParams(window.location.search).has("autofill")) {
      const messages = [
        "Please wait — loading…",
        "Tip: try searching something simple first."
      ];
      const overlay = document.createElement("div");
      Object.assign(overlay.style, {
        position: "fixed", top: 0, left: 0, width: "100%", height: "100%",
        background: "rgba(0,0,0,0.7)", color: "#fff", display: "flex", flexDirection: "column",
        justifyContent: "center", alignItems: "center", fontSize: "24px", zIndex: "9999999",
      });
      const msg = document.createElement("div");
      msg.textContent = messages[Math.floor(Math.random() * messages.length)];
      overlay.appendChild(msg);
      document.body.appendChild(overlay);
      setTimeout(()=> overlay.remove(), 4500);
    }
  </script>

  <script>
    let isLeavePopupEnabled = JSON.parse(localStorage.getItem('leavePopupEnabled'));
    if (isLeavePopupEnabled === null) isLeavePopupEnabled = false;
    window.addEventListener('beforeunload', e => {
      if (isLeavePopupEnabled) { e.preventDefault(); e.returnValue = ''; }
    });
  </script>

  <script>
    const maxHistory = 1000;
    const input = document.getElementById('address');
    const historyContainer = document.getElementById('history-container');
    const historyList = document.getElementById('history-list');
    const historySearch = document.getElementById('history-search');
    const toggleBtn = document.getElementById('toggle-history');
    const clearBtn = document.getElementById('clear-history');
    const closeBtn = document.getElementById('close-history');

    function getHistory() {
      return JSON.parse(localStorage.getItem('searchHistory') || '[]');
    }
    function saveHistory(term) {
      if (!term) return;
      let history = getHistory();
      history = history.filter(item => item.term !== term);
      let url = term.startsWith('http') ? term : `https://duckduckgo.com/?q=${encodeURIComponent(term)}`;
      history.unshift({ term, title: term, url });
      if (history.length > maxHistory) history.pop();
      localStorage.setItem('searchHistory', JSON.stringify(history));
      renderHistory();
    }
    function renderHistory(filter = '') {
      const history = getHistory().filter(item => item.term.toLowerCase().includes(filter.toLowerCase()));
      historyList.innerHTML = '';
      history.forEach((item, index) => {
        const li = document.createElement('li');
        li.style.cursor = 'pointer';
        li.style.display = 'flex';
        li.style.alignItems = 'center';
        li.style.gap = '8px';
        const img = document.createElement('img');
        img.src = `https://www.google.com/s2/favicons?domain=${item.url}`;
        img.width = 16; img.height = 16;
        const text = document.createElement('span');
        text.textContent = `${item.title} (${item.url})`;
        li.appendChild(img); li.appendChild(text);
        li.onclick = () => {
          input.value = item.term;
          window.location.href = `/active/index.html?autofill=${encodeURIComponent(item.term)}`;
          historyContainer.style.display = 'none';
        };
        historyList.appendChild(li);
      });
    }
    input.addEventListener('keydown', e => { if (e.key === 'Enter') saveHistory(input.value); });
    historySearch.addEventListener('input', () => renderHistory(historySearch.value));
    toggleBtn.addEventListener('click', () => {
      historyContainer.style.display = historyContainer.style.display === 'none' ? 'block' : 'none';
      historySearch.value = ''; renderHistory();
    });
    closeBtn.addEventListener('click', () => { historyContainer.style.display = 'none'; });
    clearBtn.addEventListener('click', () => {
      if (confirm('Clear all history?')) { localStorage.removeItem('searchHistory'); renderHistory(); }
    });
    document.addEventListener('click', e => {
      if (!historyContainer.contains(e.target) && e.target !== toggleBtn) {
        historyContainer.style.display = 'none';
      }
    });
  </script>

  <script>
    function disableAdverts() {
      if (localStorage.getItem('adsDisabled') === 'true') {
        localStorage.setItem('adsDisabled', 'false'); alert('Ads Enabled');
      } else { localStorage.setItem('adsDisabled', 'true'); alert('Ads Disabled'); }
      location.reload();
    }
  </script>
</body>
</html>
